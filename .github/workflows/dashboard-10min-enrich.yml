name: dashboard-10min (enrich)

on:
  workflow_run:
    workflows: ["dashboard-10min (core)"]
    types: [completed]

defaults:
  run:
    shell: bash

jobs:
  enrich:
    name: Enrich + Deploy after core
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 8
    concurrency:
      group: dashboard-10min-enrich
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests python-dateutil

      - name: Compute Lux strategy (10m)
        run: |
          set -euo pipefail
          python -u scripts/compute_trend10m.py || true

      - name: Update pills (10m always-on state)
        env:
          INTRADAY_URL: https://frye-market-backend-1.onrender.com/live/intraday
        run: |
          set -euo pipefail
          python -u scripts/update_pills_10m_state.py || true

      - name: Trigger Render deploy (backend-1)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND1 }}
        run: |
          set -euo pipefail
          if [ -n "${RENDER_DEPLOY_HOOK:-}" ]; then
            echo "Triggering Render deploy..."
            curl -fsS -X POST "${RENDER_DEPLOY_HOOK}"
          else
            echo "No Render deploy hook configured. Skipping."
          fi
