name: dashboard-archive-10min

on:
  # Auto-run after the live 10-minute workflow completes
  workflow_run:
    workflows: ["dashboard-10min (self-hosted, full)"]
    types: [completed]

  # Manual trigger if needed
  workflow_dispatch: {}

jobs:
  archive:
    name: Archive 10m snapshot to data-archive-10min
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      LIVE_BRANCH: data-live-10min
      ARCHIVE_BRANCH: data-archive-10min

    steps:
      - name: Skip if live job failed
        if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success' }}
        run: |
          echo "Live job conclusion=${{ github.event.workflow_run.conclusion }} â€” skipping archive."
          exit 0

      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Resolve timestamp (Arizona)
        id: ts
        run: |
          TS_LOCAL=$(TZ=America/Phoenix date +"%Y-%m-%d %H:%M:%S")
          DATE_DIR=$(TZ=America/Phoenix date +"%Y-%m-%d")
          TIME_DIR=$(TZ=America/Phoenix date +"%H%M")
          echo "ts_local=${TS_LOCAL}" >> "$GITHUB_OUTPUT"
          echo "date_dir=${DATE_DIR}" >> "$GITHUB_OUTPUT"
          echo "time_dir=${TIME_DIR}" >> "$GITHUB_OUTPUT"

      - name: Fetch live branch
        run: |
          set -euo pipefail
          git fetch --no-tags --depth=1 origin "${LIVE_BRANCH}"

      - name: Extract latest live files
        run: |
          set -euo pipefail
          mkdir -p /tmp/live
          git show "origin/${LIVE_BRANCH}:data/outlook_intraday.json" > /tmp/live/outlook_intraday.json
          git show "origin/${LIVE_BRANCH}:data/outlook_source.json"   > /tmp/live/outlook_source.json  || true
          git show "origin/${LIVE_BRANCH}:data/heartbeat_10m.txt"    > /tmp/live/heartbeat_10m.txt    || true
          test -s /tmp/live/outlook_intraday.json

      - name: Stage archive snapshot
        id: stage
        run: |
          set -euo pipefail
          ARCH_PATH="data/archives/10min/${{ steps.ts.outputs.date_dir }}/${{ steps.ts.outputs.time_dir }}"
          mkdir -p "${ARCH_PATH}"
          cp -f /tmp/live/outlook_intraday.json "${ARCH_PATH}/outlook_intraday.json"
          if [ -s /tmp/live/outlook_source.json ]; then cp -f /tmp/live/outlook_source.json "${ARCH_PATH}/outlook_source.json"; fi
          if [ -s /tmp/live/heartbeat_10m.txt ];  then cp -f /tmp/live/heartbeat_10m.txt  "${ARCH_PATH}/heartbeat_10m.txt";  fi
          echo "arch_path=${ARCH_PATH}" >> "$GITHUB_OUTPUT"

      - name: Commit to archive branch
        run: |
          set -euo pipefail
          # Switch/create archive branch
          git fetch --depth=1 origin "${ARCHIVE_BRANCH}" || true
          git checkout -B "${ARCHIVE_BRANCH}" "origin/${ARCHIVE_BRANCH}" || git checkout -B "${ARCHIVE_BRANCH}"

          # Add only the new snapshot folder
          git add -f "${{ steps.stage.outputs.arch_path }}"
          git status --porcelain

          if git diff --cached --quiet; then
            echo "Nothing new to archive."
            exit 0
          fi

          git config user.email "user@local"
          git config user.name  "CI Bot"
          git commit -m "archive 10m @ ${{ steps.ts.outputs.ts_local }} (AZ)"
          git push -f origin "${ARCHIVE_BRANCH}"

      - name: Done
        run: |
          echo "::notice:: archived 10m snapshot to ${ARCHIVE_BRANCH}/${{ steps.stage.outputs.arch_path }}"
