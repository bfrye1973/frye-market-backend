name: Intraday DELTAS (5-minute)

on:
  # Only runs when triggered via workflow_dispatch
  # (your Windows scheduler / trigger_deltas_5m.py)
  workflow_dispatch: {}

jobs:
  build-and-publish:
    name: Build & Publish 5m DELTAS
    runs-on: ubuntu-latest
    timeout-minutes: 10

    concurrency:
      group: intraday-deltas-5m
      cancel-in-progress: true

    permissions:
      contents: write

    env:
      LIVE_URL: https://frye-market-backend-1.onrender.com/live/intraday
      BRANCH: data-live-5min-deltas
      PYTHONUNBUFFERED: "1"

    steps:
      # Checkout the repo (main branch)
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------------
      # 1) Run official 5-minute DELTAS builder
      #    This script must:
      #      - read LIVE_URL
      #      - generate 5-minute deltas
      #      - write data/pills.json
      # ------------------------------------------------------------------
      - name: Run 5m DELTAS Builder
        env:
          LIVE_URL: ${{ env.LIVE_URL }}
        run: |
          python -u scripts/build_5m_deltas.py

          if [ ! -f data/pills.json ]; then
            echo "ERROR: data/pills.json not found after build_5m_deltas.py"
            exit 1
          fi

          # Stash the generated pills file in /tmp so we can switch branches
          mkdir -p /tmp
          cp data/pills.json /tmp/pills_5m.json

      # ------------------------------------------------------------------
      # 2) Publish pills.json to data-live-5min-deltas branch
      # ------------------------------------------------------------------
      - name: Publish to branch
        env:
          BRANCH: ${{ env.BRANCH }}
        run: |
          set -e

          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

          # Fetch remote branch if it exists
          git fetch origin "$BRANCH" --depth=1 || echo "(no remote branch yet)"

          # Check out the branch (create if needed)
          if git rev-parse --verify "$BRANCH" >/dev/null 2>&1; then
            git checkout "$BRANCH"
          else
            git checkout -b "$BRANCH"
          fi

          # Restore the pills file into this branch
          mkdir -p data
          cp /tmp/pills_5m.json data/pills.json

          git add data/pills.json
          git commit -m "5m deltas update $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || { echo "No changes"; exit 0; }
          git push origin "$BRANCH"
