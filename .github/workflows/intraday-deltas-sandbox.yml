name: Intraday DELTAS (5-minute)

on:
  workflow_dispatch: {}
  schedule:
    # Runs every 5 minutes during RTH (12:00–21:00 UTC = 5:00–14:00 AZ)
    - cron: "*/5 12-21 * * 1-5"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    concurrency:
      group: intraday-deltas-5m
      cancel-in-progress: true

    permissions:
      contents: write

    env:
      LIVE_URL: https://frye-market-backend-1.onrender.com/live/intraday
      BRANCH: data-live-intraday-5m

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set BUILD_DIR
        run: echo "BUILD_DIR=./data/intraday" >> $GITHUB_ENV

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run poller
        run: python make_intraday_deltas.py

      - name: Publish to branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin $BRANCH || true
          git switch --quiet --force-create $BRANCH || git switch $BRANCH

          rsync -av --delete $BUILD_DIR/ .

          git add .
          git commit -m "5m intraday deltas update $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "No changes"
          git push origin $BRANCH
