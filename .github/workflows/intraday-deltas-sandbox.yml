name: Intraday DELTAS (5-minute)

on:
  # Only runs when triggered via workflow_dispatch
  # (your Windows scheduler / trigger_deltas_5m.py)
  workflow_dispatch: {}

jobs:
  build-and-publish:
    name: Build & Publish Intraday DELTAS (5m)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    concurrency:
      group: intraday-deltas-5m
      cancel-in-progress: true

    permissions:
      contents: write

    env:
      LIVE_URL: https://frye-market-backend-1.onrender.com/live/intraday
      BRANCH: data-live-5min-deltas        # per teammate: /live/pills reads from this branch
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # === THIS IS THE ONLY SCRIPT WE RUN ===
      - name: Run 5m Deltas Builder
        run: |
          python -u scripts/build_5m_deltas.py

      - name: Publish to branch
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

          git fetch origin "$BRANCH" --depth=1 || echo "(new branch)"
          git checkout -B "$BRANCH" "origin/$BRANCH" || git checkout -B "$BRANCH"
          git branch --set-upstream-to="origin/$BRANCH" "$BRANCH" || echo "(no upstream)"

          mkdir -p data
          cp -f data/pills.json data/pills.json

          git add data/pills.json
          git commit -m "5m deltas update $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || { echo "No changes"; exit 0; }
          git push origin "$BRANCH"
