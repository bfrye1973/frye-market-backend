name: dashboard-4h

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "baseline = full scan all symbols (slow). incremental = only update changed symbols (fast)."
        required: true
        default: "incremental"
        type: choice
        options:
          - baseline
          - incremental
  schedule:
    # Run incremental on a cadence (Mon–Fri). Adjust later if desired.
    - cron: "10 */4 * * 1-5"

defaults:
  run:
    shell: bash

jobs:
  build_and_publish_4h:
    name: Build and Publish 4H
    runs-on: ubuntu-latest
    # baseline needs more time; incremental stays fast
    timeout-minutes: 180
    permissions:
      contents: write
    concurrency:
      group: dashboard-4h
      cancel-in-progress: true

    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-4h
      PYTHONUNBUFFERED: "1"
      FD_MAX_WORKERS: "16"

      # ✅ Your choice: 14 day cushion
      H4_LOOKBACK_DAYS: "14"

      # IMPORTANT: MUST MATCH your 1H NH/NL BAR COUNT WINDOW (do not change concept)
      H4_LOOKBACK_BARS: "20"

      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      POLY_KEY: ${{ secrets.POLY_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --upgrade requests python-dateutil tzdata

      - name: Determine mode (baseline vs incremental)
        id: mode
        run: |
          set -euo pipefail
          MODE="incremental"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.mode }}"
          fi
          echo "MODE=$MODE" >> "$GITHUB_ENV"
          echo "::notice:: MODE=$MODE"

      # Pull prior cache from live branch if exists (for incremental)
      - name: Restore prior cache if exists
        run: |
          set -euo pipefail
          mkdir -p data
          if git ls-remote --exit-code --heads origin "${LIVE_BRANCH}" >/dev/null 2>&1; then
            git fetch --no-tags --depth=1 origin "${LIVE_BRANCH}"
            git show "origin/${LIVE_BRANCH}:data/4h_cache.json" > data/4h_cache.json 2>/dev/null || true
            if [ -s data/4h_cache.json ]; then
              echo "::notice:: Restored prior 4H cache"
            else
              echo "::notice:: No prior 4H cache found"
            fi
          else
            echo "::notice:: Live branch ${LIVE_BRANCH} does not exist yet"
          fi

      # 1) Build 4H sectorCards source (baseline or incremental)
      - name: Build 4H sectorCards source (baseline/incremental)
        run: |
          set -euo pipefail
          mkdir -p data
          python -u scripts/build_outlook_4h_source.py \
            --mode "${MODE}" \
            --sectors-dir "data/sectors" \
            --lookback-bars "${H4_LOOKBACK_BARS}" \
            --lookback-days "${H4_LOOKBACK_DAYS}" \
            --cache "data/4h_cache.json" \
            --out   "data/outlook_source_4h.json"
          python - <<'PY'
          import json,sys
          s=json.load(open("data/outlook_source_4h.json","r",encoding="utf-8"))
          cards=s.get("sectorCards") or []
          if not isinstance(cards,list) or len(cards)==0:
            print("INVALID 4H source sectorCards"); sys.exit(2)
          print("OK source cards=",len(cards))
          PY

      # 2) Build 4H payload
      - name: Build 4H payload
        run: |
          set -euo pipefail
          python -u scripts/make_dashboard_4h.py \
            --source "data/outlook_source_4h.json" \
            --out    "data/outlook_4h.json"

      # 3) Post-process 4H (colors + mirrors)
      - name: Compute 4H trend capsule
        run: |
          set -euo pipefail
          python -u scripts/compute_trend_4h.py

      # 4) Validate payload
      - name: Validate required keys
        run: |
          set -euo pipefail
          python - <<'PY'
          import json,sys
          j=json.load(open("data/outlook_4h.json","r",encoding="utf-8"))
          m=j.get("metrics") or {}
          need=("breadth_4h_pct","momentum_4h_pct","squeeze_4h_pct","liquidity_4h","volatility_4h_pct","trend_strength_4h_pct")
          miss=[k for k in need if k not in m]
          sc=j.get("sectorCards") or []
          if miss or not isinstance(sc,list) or len(sc)!=11:
              print("missing:", miss, "len(sectorCards)=",len(sc)); sys.exit(1)
          print("OK metrics & sectorCards")
          PY

      # 5) Heartbeat
      - name: Write heartbeat
        run: |
          set -euo pipefail
          date -u +'%Y-%m-%dT%H:%M:%SZ' > data/heartbeat_4h.txt

      # 6) Publish live branch
      - name: Publish live branch
        run: |
          set -euo pipefail

          TMP_DIR="$(mktemp -d)"
          cp -f data/outlook_4h.json    "${TMP_DIR}/outlook_4h.json"
          cp -f data/heartbeat_4h.txt   "${TMP_DIR}/heartbeat_4h.txt"
          cp -f data/4h_cache.json      "${TMP_DIR}/4h_cache.json"

          git config user.email "user@local"
          git config user.name  "CI Bot"

          git fetch --depth=1 origin "${LIVE_BRANCH}" || true

          git rm -r --cached . 2>/dev/null || true
          git reset --hard
          git clean -fdx

          if git ls-remote --exit-code --heads origin "${LIVE_BRANCH}" >/dev/null 2>&1; then
            git checkout -B "${LIVE_BRANCH}" "origin/${LIVE_BRANCH}"
          else
            git checkout -B "${LIVE_BRANCH}"
          fi
          git branch --set-upstream-to="origin/${LIVE_BRANCH}" "${LIVE_BRANCH}" || true

          mkdir -p data
          mv "${TMP_DIR}/outlook_4h.json"  data/outlook_4h.json
          mv "${TMP_DIR}/heartbeat_4h.txt" data/heartbeat_4h.txt
          mv "${TMP_DIR}/4h_cache.json"    data/4h_cache.json

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "4h publish $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push origin "${LIVE_BRANCH}"
