name: dashboard-10min (self-hosted, minimal)

on:
  workflow_dispatch: {}
  # add a schedule only after it's stable
  # schedule:
  #   - cron: '*/10 * * * *'   # every 10 minutes

jobs:
  tenmin:
    runs-on: [self-hosted, Windows, tenmin]
    timeout-minutes: 30

    steps:
      # --- 1) NORMAL CHECKOUT (no sparse, no archive paths) ---
      - name: Checkout repository (no sparse)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      # --- 2) (Optional) confirm Python is available ---
      - name: Show Python (if present)
        shell: powershell
        run: |
          if (Get-Command python -ErrorAction SilentlyContinue) {
            python --version
          } else {
            Write-Host "Python not found on PATH (that's OK if your build doesn't need it)."
          }

      # --- 3) Build sectorCards source (only if your script exists) ---
      - name: Build sectorCards source (10m)
        shell: powershell
        run: |
          $script = "scripts/build_outlook_source_from_polygon.py"
          if (Test-Path $script) {
            Write-Host "Running $script ..."
            python $script --mode intraday10 --out data/outlook_source.json
          } else {
            Write-Host "SKIP: $script not found."
          }

      # --- 4) Build intraday payload (only if your script exists) ---
      - name: Build intraday payload
        shell: powershell
        run: |
          $script = "scripts/make_dashboard.py"
          if (Test-Path $script) {
            Write-Host "Running $script ..."
            python $script --source data/outlook_source.json --out data/outlook_intraday.json
          } else {
            Write-Host "SKIP: $script not found."
          }

      # --- 5) (Optional) publish only if the output file changed ---
      - name: Publish to live branch (only on change)
        shell: powershell
        env:
          LIVE_BRANCH: data-live-10min
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $out = "data/outlook_intraday.json"
          if (-Not (Test-Path $out)) {
            Write-Host "SKIP: $out does not exist — nothing to publish."
            exit 0
          }

          git config user.name  "actions-bot"
          git config user.email "bot@users.noreply.github.com"

          # Fetch the live branch (if it exists) and compare file contents
          git fetch --no-tags --depth=1 origin $env:LIVE_BRANCH 2>$null

          $tmp = Join-Path $env:RUNNER_TEMP "prev.json"
          if (git ls-remote --heads origin $env:LIVE_BRANCH) {
            git show "origin/$env:LIVE_BRANCH:$out" > $tmp 2>$null
          }

          if ((Test-Path $tmp) -and (Compare-Object (Get-Content $out) (Get-Content $tmp) -SyncWindow 0 -CaseSensitive:$false | Measure-Object).Count -eq 0) {
            Write-Host "No content change in $out — skipping publish."
            exit 0
          }

          # Publish the new file to the live branch
          git checkout -B $env:LIVE_BRANCH
          git add $out
          git commit -m "10m publish $(Get-Date -Format s)Z" 2>$null
          git push -f "https://x-access-token:${env:GH_TOKEN}@github.com/${{ github.repository }}.git" $env:LIVE_BRANCH

      - name: Done
        shell: powershell
        run: Write-Host "10m job complete."
