name: dashboard-10min (self-hosted, minimal)

on:
  workflow_dispatch: {}
  # run every 12 minutes on weekdays (adjust if you like)
  schedule:
    - cron: "*/12 * * * 1-5"

jobs:
  tenmin:
    # use the labels of your self-hosted runner
    runs-on: [self-hosted, Windows, tenmin]
    timeout-minutes: 20

    steps:
      - name: Checkout repository (no sparse)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ---------- BUILD SECTORS SOURCE (10m) ----------
      - name: Build sectorCards source (10m)
        env:
          # IMPORTANT: pass the key so the script can authenticate with Polygon
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          POLY_KEY:        ${{ secrets.POLYGON_API_KEY }}   # script also checks these
          REACT_APP_POLYGON_KEY: ${{ secrets.POLYGON_API_KEY }}

          # your safe flags (unchanged behavior unless you flip them)
          FD_SCALPER_ENABLE: "false"
          FD_HOURLY_INTRADAY: "true"
          FD_SCALPER_LOOKBACK: "5"
          FD_MAX_WORKERS: "8"
        run: |
          python -u scripts/build_outlook_source_from_polygon.py ^
            --mode intraday10 ^
            --out data/outlook_source.json

      # ---------- BUILD INTRADAY PAYLOAD (10m) ----------
      # keep the script/args your repo already uses for this step
      - name: Build intraday payload (10m)
        run: |
          python -u scripts/build_intraday_payload.py ^
            --source data/outlook_source.json ^
            --out data/outlook_intraday.json

      # ---------- PUBLISH ONLY WHEN THE FILE CHANGED ----------
      - name: Detect change vs remote
        id: diff
        shell: pwsh
        run: |
          $branch = 'data-live-10min'
          git fetch --depth=1 origin $branch 2>$null || echo "no remote branch yet"
          $changed = "true"
          if (Test-Path 'data/outlook_intraday.json') {
            $remote = ''
            try { $remote = git show "origin/$branch:data/outlook_intraday.json" 2>$null } catch {}
            if ($remote -ne '') {
              $local  = Get-Content -Raw 'data/outlook_intraday.json'
              if ($remote -eq $local) { $changed = "false" }
            }
          }
          "changed=$changed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Publish to live branch (only on change)
        if: steps.diff.outputs.changed == 'true'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $branch = 'data-live-10min'
          git config user.name  "actions-bot"
          git config user.email "bot@users.noreply.github.com"

          git fetch --depth=1 origin 2>$null || echo "first publish"
          git checkout -B $branch "origin/$branch" 2>$null || git checkout -B $branch

          mkdir -Force data
          Copy-Item -Force 'data/outlook_intraday.json' 'data/outlook_intraday.json'

          git add data/outlook_intraday.json
          git commit -m ("10m live {0:yyyy-MM-ddTHH:mm:ssZ}" -f (Get-Date).ToUniversalTime()) `
            || echo "nothing to commit"
          git push -f origin $branch
