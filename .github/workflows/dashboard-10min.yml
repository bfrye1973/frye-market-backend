name: dashboard-10min (self-hosted, clean rebuild)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30-55/5 12 * * 1-5"
    - cron: "*/5 13-23 * * 1-5"
    - cron: "*/5 0-1 * * 2-6"

jobs:
  tenmin:
    name: Build & Publish Intraday (10m)
    runs-on: self-hosted
    timeout-minutes: 30
    permissions:
      contents: write
    concurrency:
      group: dashboard-10min
      cancel-in-progress: false

    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      PYTHONUNBUFFERED: "1"
      FD_SCALPER_ENABLE: "true"
      FD_SCALPER_LOOKBACK: "3"
      FD_LOOKBACK_DAYS: "0"
      FD_MAX_WORKERS: "3"
      FD_RETRY_MAX: "1"
      POLY_KEY: ${{ secrets.POLY_KEY }}
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}

    steps:
      - name: Start timer (UTC)
        shell: cmd
        run: |
          for /f "tokens=2 delims==" %%A in ('wmic os get localdatetime /value ^| find "="') do set TS=%%A
          set START_TS=%TS:~0,4%-%TS:~4,2%-%TS:~6,2%T%TS:~8,2%:%TS:~10,2%:%TS:~12,2%Z
          echo ==== START %START_TS%

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure tzdata
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade tzdata

      - name: Build source
        shell: cmd
        run: |
          if not exist data mkdir data
          python -u scripts\build_outlook_source_from_polygon.py ^
            --mode intraday10 ^
            --sectors-dir data\sectors ^
            --out data\outlook_source.json
          if errorlevel 1 exit /b 1

      - name: Build intraday payload
        shell: cmd
        run: |
          python -u scripts\make_dashboard.py ^
            --mode intraday ^
            --source data\outlook_source.json ^
            --out data\outlook_intraday.json
          if errorlevel 1 exit /b 1

      - name: Compute Lux (safe)
        shell: cmd
        run: python -u scripts\compute_trend10m.py
        continue-on-error: true

      - name: Update pills (safe)
        shell: cmd
        run: python -u scripts\update_pills_10m_state.py
        continue-on-error: true

      - name: Write heartbeat
        shell: cmd
        run: |
          for /f "tokens=2 delims==" %%A in ('wmic os get localdatetime /value ^| find "="') do set TS=%%A
          set HB=%TS:~0,4%-%TS:~4,2%-%TS:~6,2%T%TS:~8,2%:%TS:~10,2%:%TS:~12,2%Z
          echo %HB%> data\heartbeat_10m.txt

      - name: Stage artifacts
        shell: cmd
        run: |
          if not exist publish mkdir publish
          copy /Y data\outlook_source.json   publish\outlook_source.json
          copy /Y data\outlook_intraday.json publish\outlook_intraday.json
          copy /Y data\heartbeat_10m.txt     publish\heartbeat_10m.txt
          dir publish

      - name: Publish clean branch
        shell: cmd
        run: |
          echo ==== PUBLISH to %LIVE_BRANCH% ====
          git config user.email "user@local"
          git config user.name  "CI Bot"
          git fetch --depth=1 origin || echo nofetch
          git checkout -B %LIVE_BRANCH%
          if exist data rd /s /q data
          mkdir data
          copy /Y publish\outlook_source.json   data\outlook_source.json
          copy /Y publish\outlook_intraday.json data\outlook_intraday.json
          copy /Y publish\heartbeat_10m.txt     data\heartbeat_10m.txt
          git add -f data\outlook_source.json
          git add -f data\outlook_intraday.json
          git add -f data\heartbeat_10m.txt
          git commit -m "10m publish %START_TS%" || (echo nothing & exit /b 0)
          git push -f origin %LIVE_BRANCH%
          echo ==== DONE %START_TS%
