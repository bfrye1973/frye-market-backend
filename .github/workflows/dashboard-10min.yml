name: dashboard-10min (self-hosted, stable)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/10 * * * 1-5"

defaults:
  run:
    shell: cmd

jobs:
  tenmin:
    name: Build & Publish Intraday (10m)
    runs-on: self-hosted
    timeout-minutes: 30
    permissions:
      contents: write
    concurrency:
      group: dashboard-10min
      cancel-in-progress: true
    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      PYTHONUNBUFFERED: "1"
      POLY_KEY: ${{ secrets.POLY_KEY }}
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}

    steps:
      - name: Start timer (UTC)
        run: |
          for /f "tokens=2 delims==" %%A in ('wmic os get localdatetime /value ^| find "="') do set TS=%%A
          set START_TS=%TS:~0,4%-%TS:~4,2%-%TS:~6,2%T%TS:~8,2%:%TS:~10,2%:%TS:~12,2%Z
          echo START_TS=%START_TS%>>%GITHUB_ENV%
          echo ::notice:: 10m run started at %START_TS%

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure deps (Windows)
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade tzdata requests python-dateutil

      # 1) Build intraday source (LIVE)
      - name: Build sectorCards source (intraday)
        run: |
          if not exist data mkdir data
          python -u scripts\build_outlook_source_from_polygon.py ^
            --mode intraday ^
            --out data\outlook_source.json
          if errorlevel 1 exit /b 1

      # 2) Compose intraday payload
      - name: Build intraday payload (10m)
        run: |
          python -u scripts\make_dashboard.py ^
            --mode intraday ^
            --source data\outlook_source.json ^
            --out data\outlook_intraday.json
          if errorlevel 1 exit /b 1

      # 3) Lux / Engine Lights (safe)
      - name: Compute trend10m (safe)
        run: python -u scripts\compute_trend10m.py || echo safe

      - name: Update 10m pills (safe)
        run: python -u scripts\update_pills_10m_state.py || echo safe

      # 4) Validate keys (cmd-safe)
      - name: Validate required keys
        run: |
          echo import json> %CD%\check10m.py
          echo import sys>> %CD%\check10m.py
          echo j=json.load(open(r"data\outlook_intraday.json","r",encoding="utf-8"))>> %CD%\check10m.py
          echo m=j.get("metrics") or {}>> %CD%\check10m.py
          echo sc=j.get("sectorCards") or []>> %CD%\check10m.py
          echo assert isinstance(m,dict) and m, "Missing metrics">> %CD%\check10m.py
          echo assert isinstance(sc,list) and len(sc)==11, "Invalid sectorCards">> %CD%\check10m.py
          echo print("OK: metrics and sectorCards")>> %CD%\check10m.py
          python %CD%\check10m.py

      # 5) Heartbeat (AZ local time)
      - name: Write heartbeat
        run: |
          for /f "tokens=2 delims==" %%A in ('wmic os get localdatetime /value ^| find "="') do set TS=%%A
          set HB=%TS:~0,4%-%TS:~4,2%-%TS:~6,2% %TS:~8,2%:%TS:~10,2%:%TS:~12,2%
          > data\heartbeat_10m.txt echo %HB%
          type data\heartbeat_10m.txt

      # 6) Stage artifacts
      - name: Stage artifacts
        run: |
          if not exist publish mkdir publish
          copy /Y data\outlook_source.json   publish\outlook_source.json
          copy /Y data\outlook_intraday.json publish\outlook_intraday.json
          copy /Y data\heartbeat_10m.txt     publish\heartbeat_10m.txt
          dir publish

      # 7) Diff remote vs local (compare JSON)
      - name: Detect change vs remote
        id: diff
        run: |
          git fetch origin %LIVE_BRANCH% --depth=1 || echo (no remote yet)
          set CHANGED=true
          if exist _remote_tmp rd /s /q _remote_tmp
          mkdir _remote_tmp
          git --work-tree="_remote_tmp" checkout origin/%LIVE_BRANCH% -- "data\outlook_intraday.json" 2>nul || echo (no remote JSON)
          if exist _remote_tmp\data\outlook_intraday.json (
            fc /B publish\outlook_intraday.json _remote_tmp\data\outlook_intraday.json >nul 2>&1
            if "%ERRORLEVEL%"=="0" set CHANGED=false
          )
          echo changed=%CHANGED%>>%GITHUB_OUTPUT%
          echo ::notice:: changed=%CHANGED%

      # 8) Publish (clean checkout + lease push)
      - name: Publish live branch
        if: ${{ steps.diff.outputs.changed == 'true' }}
        run: |
          git config user.email "bot@ci.local"
          git config user.name  "CI Bot"

          rem Clean workspace before checkout
          git rm -r --cached . 2>nul || echo (no index)
          git reset --hard
          git clean -fdx

          git fetch --depth=1 origin %LIVE_BRANCH% || echo (new branch)
          git checkout -B %LIVE_BRANCH% "origin/%LIVE_BRANCH%" || git checkout -B %LIVE_BRANCH%

          if exist data rd /s /q data
          mkdir data
          copy /Y publish\outlook_source.json   data\outlook_source.json
          copy /Y publish\outlook_intraday.json data\outlook_intraday.json
          copy /Y publish\heartbeat_10m.txt     data\heartbeat_10m.txt

          git add -A
          git commit -m "10m publish %START_TS%" || (echo nothing to commit & exit /b 0)
          git push --force-with-lease origin %LIVE_BRANCH%

      - name: Done
        run: echo DONE %DATE% %TIME%
