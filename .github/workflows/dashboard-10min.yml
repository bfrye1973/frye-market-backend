name: dashboard-10min (self-hosted)

on:
  workflow_dispatch:
  # once stable, you can re-enable your schedule
  # schedule:
  #   - cron: "*/12 * * * 1-5"

jobs:
  tenmin:
    # IMPORTANT: your runner already shows these labels (self-hosted, Windows, X64).
    # You also added the label 'tenmin' on the runner page. We use all four here:
    runs-on: [ self-hosted, Windows, X64, tenmin ]
    timeout-minutes: 30

    steps:
      # 0) Make absolutely sure the workspace is clean so checkout never conflicts
      - name: Prepare workspace (clean)
        shell: pwsh
        run: |
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
          if (Test-Path "$env:GITHUB_WORKSPACE\.git") {
            # If it's a git repo but in a bad state, drop it and recreate
            try {
              git -C "$env:GITHUB_WORKSPACE" rev-parse --is-inside-work-tree | Out-Null
              if ($LASTEXITCODE -ne 0) {
                Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
              }
            } catch {
              Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            }
          } else {
            # Not a repo – just ensure the folder is empty
            Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }

      # 1) Checkout repo – no sparse/extra inputs, just a plain clean fetch
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      # 2) Quick sanity check so we can see the branch & last commit
      - name: Verify repository state
        shell: pwsh
        run: |
          git rev-parse --abbrev-ref HEAD
          git log -1 --oneline

      # 3) (Optional) Re-enable build steps one-by-one AFTER checkout is green.
      #    For now this is just a placeholder so the job succeeds and proves runner/checkout are solid.
      - name: Placeholder build step
        shell: pwsh
        run: |
          Write-Host "Checkout is good. Runner is working. Next: re-enable your real build steps."

      # Example: when ready, re-enable your real scripts one at a time
      # - name: Build sectorCards source (10m)
      #   shell: pwsh
      #   env:
      #     POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      #   run: |
      #     python scripts/build_outlook_source_from_polygon.py --mode intraday10 --out data/outlook_source.json

      # - name: Normalize source
      #   shell: pwsh
      #   run: |
      #     python scripts/normalize_source.py

      - name: Done
        shell: pwsh
        run: Write-Host "10m self-hosted pipeline finished."
