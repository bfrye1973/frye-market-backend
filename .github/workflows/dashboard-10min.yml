name: dashboard-10min (github-runner, debug-publish)

on:
  workflow_dispatch: {}
  schedule:
    # run every 7 minutes
    - cron: "*/7 * * * 1-5"

jobs:
  build-and-publish-10m:
    name: Build & Publish Intraday (10m — debug)
    runs-on: self-hosted
    timeout-minutes: 15
    permissions:
      contents: write
    concurrency:
      group: dashboard-10min
      cancel-in-progress: true

    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      PYTHONUNBUFFERED: "1"

    steps:

      # ---------------------------------------
      # 0) Startup
      # ---------------------------------------
      - name: Set up job
        run: |
          echo "Starting fast 10m workflow…"

      - name: Start timer (UTC)
        run: |
          echo "START_TS=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --upgrade requests python-dateutil tzdata

      # ---------------------------------------
      # 1) Build sectorCards source
      # ---------------------------------------
      - name: Build sectorCards source (intraday10)
        run: |
          set -e
          mkdir -p data
          python -u scripts/build_outlook_source_from_polygon.py \
            --sectors-dir data/sectors \
            --out data/outlook_source.json
          head -n 40 data/outlook_source.json || true

      # ---------------------------------------
      # 2) Build intraday payload
      # ---------------------------------------
      - name: Build intraday payload (10m)
        run: |
          set -e
          python -u scripts/make_dashboard.py \
            --mode intraday \
            --source data/outlook_source.json \
            --out data/outlook_intraday.json
          head -n 60 data/outlook_intraday.json || true

      # ---------------------------------------
      # 3) Compute Lux (optional)
      # ---------------------------------------
      - name: Compute Lux strategy (10m)
        run: |
          python -u scripts/compute_trend10m.py || true

      # ---------------------------------------
      # 4) Validate
      # ---------------------------------------
      - name: Validate metrics & sectorCards
        run: |
          python - << 'PY'
          import json, sys
          j = json.load(open("data/outlook_intraday.json"))
          m = j.get("metrics") or {}
          need = ["breadth_10m_pct","momentum_10m_pct",
                  "squeeze_pct","liquidity_psi","volatility_pct"]
          miss = [k for k in need if k not in m]
          sc = j.get("sectorCards") or []
          if miss or len(sc)!=11:
              print("FAILED:", miss, "sectorCards:", len(sc))
              sys.exit(1)
          print("Validation OK")
          PY

      # ---------------------------------------
      # 5) Heartbeat
      # ---------------------------------------
      - name: Write heartbeat
        run: |
          date -u +"%Y-%m-%dT%H:%M:%SZ" > data/heartbeat_10m.txt

      # ---------------------------------------
      # 6) Detect change (FAST MODE – NO CLEAN RESET)
      # ---------------------------------------
      - name: Detect change
        id: diff
        run: |
          set -e
          CHANGED="true"

          # fetch existing branch if exists
          git fetch --depth=1 origin "${LIVE_BRANCH}" || true

          # compare JSON
          if git ls-remote --exit-code --heads origin "${LIVE_BRANCH}" >/dev/null 2>&1; then
            git show "origin/${LIVE_BRANCH}:data/outlook_intraday.json" > prev.json 2>/dev/null || true
            if [ -s prev.json ] && cmp -s prev.json data/outlook_intraday.json; then
              CHANGED="false"
            fi
          fi

          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # ---------------------------------------
      # 7) Publish
      # ---------------------------------------
      - name: Publish live branch
        if: ${{ steps.diff.outputs.changed == 'true' }}
        run: |
          set -e
          git config user.email "bot@ci.local"
          git config user.name  "CI Bot"

          git fetch --depth=1 origin "${LIVE_BRANCH}" || true
          git checkout -B "${LIVE_BRANCH}" || true

          mkdir -p data
          cp -f data/outlook_intraday.json data/
          cp -f data/outlook_source.json data/
          cp -f data/heartbeat_10m.txt data/

          git add -A
          git commit -m "publish 10m ${START_TS}" || true
          git push origin "${LIVE_BRANCH}"

      # ---------------------------------------
      # 8) Done
      # ---------------------------------------
      - name: Done
        run: echo "10m workflow complete (FAST MODE)"
