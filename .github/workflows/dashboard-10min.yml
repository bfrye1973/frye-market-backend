name: dashboard-10min

on:
  workflow_dispatch: {}
  schedule:
    # Stable cadence (no overlap). Adjust later if desired.
    - cron: "*/12 * * * 1-5"

jobs:
  tenmin:
    name: Build & Publish Intraday (10m + Lux + Pulse)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: write
    concurrency:
      group: dashboard-10min
      cancel-in-progress: true

    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      PYTHONUNBUFFERED: "1"

      # Collector knobs for stable runtime
      FD_SCALPER_ENABLE: "true"
      FD_SCALPER_LOOKBACK: "3"
      FD_MAX_WORKERS: "6"
      FD_RETRY_MAX: "1"
      FD_LOOKBACK_DAYS: "0"

      # File paths
      INTRADAY_JSON_PATH: "data/outlook_intraday.json"

      # URLs (used for debug & optional pulse delta)
      INTRADAY_URL: "https://fr ye-market-backend-1.onrender.com/live/intraday"
      HOURLY_URL:   "https://fr ye-market-backend-1.onrender.com/live/hourly"
      PREV_JSON_URL: "https://raw.githubusercontent.com/bfrye1973/frye-market-backend/data-live-10min/data/outlook_intraday.json"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------------
      # 1) Build intraday source from Polygon (today-only, throttled)
      # ------------------------------------------------------------------
      - name: Build sectorCards source (10m)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          FD_SCALPER_ENABLE: ${{ env.FD_SCALPER_ENABLE }}
          FD_SCALPER_LOOKBACK: ${{ env.FD_SCALPER_LOOKBACK }}
          FD_MAX_WORKERS: ${{ env.FD_MAX_WORKERS }}
          FD_RETRY_MAX: ${{ env.FD_RETRY_MAX }}
          FD_LOOKBACK_DAYS: ${{ env.FD_LOOKBACK_DAYS }}
        run: |
          set -euo pipefail
          echo "::notice::collector starting"
          python -u scripts/build_outlook_source_from_polygon.py \
            --mode intraday10 \
            --out data/outlook_source.json
          test -s data/outlook_source.json || (echo "::error::missing data/outlook_source.json"; exit 2)
          echo "::notice::collector done"

      # ------------------------------------------------------------------
      # 2) Build the actual intraday payload JSON
      # ------------------------------------------------------------------
      - name: Build intraday payload (FULL)
        run: |
          set -euo pipefail
          python -u scripts/make_dashboard.py \
            --source data/outlook_source.json \
            --out    "$INTRADAY_JSON_PATH"
          test -s "$INTRADAY_JSON_PATH" || (echo "::error::missing $INTRADAY_JSON_PATH"; exit 2)
          echo "::notice::built $INTRADAY_JSON_PATH"

      # ------------------------------------------------------------------
      # 3) Compute Lux (10m)
      # ------------------------------------------------------------------
      - name: Compute Lux strategy (10m)
        run: |
          set -euo pipefail
          python -u scripts/compute_trend10m.py || true
          test -s "$INTRADAY_JSON_PATH" || (echo "::error::post-lux JSON not found"; exit 2)

      # ------------------------------------------------------------------
      # 4) Compute Pulse (10m) and mirror risingPct
      # ------------------------------------------------------------------
      - name: Compute Pulse (10m)
        env:
          INTRADAY_JSON_PATH: ${{ env.INTRADAY_JSON_PATH }}
          PREV_JSON_URL: ${{ env.PREV_JSON_URL }}
        run: |
          set -euo pipefail
          python -u scripts/compute_pulse10m.py
          test -s "$INTRADAY_JSON_PATH" || (echo "::error::post-pulse JSON not found"; exit 2)
          echo "------ Pulse preview ------"
          jq '.pulse10m // {} | {signal, pulseDelta, offenseTilt, defensiveTilt, greenCount, redCount, risingPct}' "$INTRADAY_JSON_PATH" || true
          echo "------ SectorDirection10m preview ------"
          jq '.intraday.sectorDirection10m // {}' "$INTRADAY_JSON_PATH" || true

      # ------------------------------------------------------------------
      # 5) Stamp last_full_run_utc
      # ------------------------------------------------------------------
      - name: Stamp last_full_run_utc
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, datetime
          p="data/outlook_intraday.json"
          j=json.load(open(p,"r",encoding="utf-8"))
          j.setdefault("meta", {})["last_full_run_utc"] = datetime.datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
          json.dump(j, open(p,"w",encoding="utf-8"), ensure_ascii=False, separators=(",",":"))
          print("[stamp] done")
          PY

      # ------------------------------------------------------------------
      # 6) Stage artifact for diff / publish
      # ------------------------------------------------------------------
      - name: Stage artifacts
        run: |
          set -euo pipefail
          mkdir -p /tmp/live10
          cp -f data/outlook_intraday.json /tmp/live10/outlook_intraday.json

      # ------------------------------------------------------------------
      # 7) Detect change vs live branch
      # ------------------------------------------------------------------
      - name: Detect change vs remote
        id: diff
        env:
          LIVE_BRANCH: ${{ env.LIVE_BRANCH }}
        run: |
          set -euo pipefail
          CHG="true"
          if git ls-remote --exit-code --heads origin "${LIVE_BRANCH}" >/dev/null 2>&1; then
            git fetch --no-tags --depth=1 origin "${LIVE_BRANCH}"
            git show "origin/${LIVE_BRANCH}:data/outlook_intraday.json" > /tmp/prev.json 2>/dev/null || true
            if [ -s /tmp/prev.json ] && cmp -s /tmp/prev.json /tmp/live10/outlook_intraday.json; then
              CHG="false"
            fi
          fi
          echo "changed=${CHG}" >> "$GITHUB_OUTPUT"
          echo "::notice::changed=${CHG}"

      # ------------------------------------------------------------------
      # 8) Publish to data-live-10min if changed
      # ------------------------------------------------------------------
      - name: Publish live branch
        if: ${{ steps.diff.outputs.changed == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LIVE_BRANCH: ${{ env.LIVE_BRANCH }}
        run: |
          set -euo pipefail
          git config user.name  "actions-bot"
          git config user.email "bot@users.noreply.github.com"
          git fetch --no-tags --depth=1 origin "${LIVE_BRANCH}" || true
          git checkout -B "${LIVE_BRANCH}" || git checkout -b "${LIVE_BRANCH}"
          git reset --hard
          git clean -fdx
          mkdir -p data
          cp -f /tmp/live10/outlook_intraday.json data/outlook_intraday.json
          git add data/outlook_intraday.json
          git commit -m "10m publish $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "nothing to commit"
          git push -f origin "${LIVE_BRANCH}"
