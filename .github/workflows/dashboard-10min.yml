name: dashboard-10min

on:
  workflow_dispatch: {}
  schedule:
    # Keep your normal weekday cadence; manual runs are allowed anytime
    - cron: "*/7 12 * * 1-5"
    - cron: "*/7 13-20 * * 1-5"

defaults:
  run:
    shell: bash

jobs:
  tenmin:
    name: Build and Publish Intraday (10m)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
    concurrency:
      group: dashboard-10min
      cancel-in-progress: true
    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests python-dateutil

      # 1) Build sector source: groups/cards used by make_dashboard.py
      - name: Build sectorCards source (10m)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p data
          python -u scripts/build_outlook_source_from_polygon.py --mode intraday10 --out data/outlook_source.json
          echo "RAW SOURCE (first 100 lines):"
          head -n 100 data/outlook_source.json || true
          # backup for later validator
          cp -f data/outlook_source.json /tmp/outlook_source.json

      - name: Normalize sector source (ensure groups or cards)
        run: |
          set -euo pipefail
          python - <<'PY'
          import json,sys
          p="data/outlook_source.json"
          try:
              j=json.load(open(p,"r",encoding="utf-8"))
          except Exception as e:
              print("missing/invalid source:", e); sys.exit(1)
          if not (isinstance(j.get("groups"),dict) or isinstance(j.get("sectorCards"),list)):
              print("INVALID source: missing groups/sectorCards"); sys.exit(1)
          print("OK: source has cards or groups")
          PY

      # 2) Build intraday
      - name: Build intraday payload (uses source)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          set -euo pipefail
          python -u scripts/make_dashboard.py \
            --mode intraday \
            --source data/outlook_source.json \
            --out data/outlook_intraday.json
          echo "Built: data/outlook_intraday.json"

      # 3) Compute Lux Strategy for 10m + mirror 1h if pills present
      - name: Compute Lux strategy (10m) + mirror 1h
        run: |
          set -euo pipefail
          python - <<'PY'
          import json,datetime,sys
          p="data/outlook_intraday.json"
          def loadp(pth):
              try: return json.load(open(pth,"r",encoding="utf-8"))
              except: return {}
          j=loadp(p)
          m=j.get("metrics",{}) or {}
          eng=(j.get("engineLights") or {})
          sigs=eng.get("signals") or {}
          now=j.get("updated_at") or j.get("updated_at_utc") or datetime.datetime.utcnow().isoformat()+"Z"

          # 10m PSI tightness is squeeze_pct (0..100)
          psi = m.get("squeeze_pct")
          tight = psi is not None and psi >= 80

          ema_sign = m.get("ema_sign",0)
          bullX = bool((sigs.get("sigEMA10BullCross") or {}).get("active")) or ema_sign>0
          bearX = bool((sigs.get("sigEMA10BearCross") or {}).get("active")) or ema_sign<0
          accelUp = bool((sigs.get("sigAccelUp") or {}).get("active"))
          accelDn = bool((sigs.get("sigAccelDown") or {}).get("active"))

          if tight:
              s10, r10 = "purple", f"PSI tight {psi:.0f}%"
          elif bullX and accelUp:
              s10, r10 = "green", "EMA10>20 + AccelUp"
          elif bearX and accelDn:
              s10, r10 = "red", "EMA10<20 + AccelDown"
          else:
              if ema_sign>0:   s10,r10="green","EMA posture up"
              elif ema_sign<0: s10,r10="red","EMA posture down"
              else:            s10,r10="purple","Neutral / no cross"

          j.setdefault("intraday",{}).setdefault("strategy",{})
          j["intraday"]["strategy"]["trend10m"]={"state":s10,"reason":r10,"updatedAt":now}

          # Mirror 1h if present in pills (from hourly mirroring)
          def active(k): return bool((sigs.get(k) or {}).get("active"))
          if any(k.startswith("sigEMA1h") or k.startswith("sigSMI1h") or k.endswith("1h") for k in sigs.keys()):
              bull1 = active("sigEMA1hBullCross") or active("sigSMI1hBullCross")
              bear1 = active("sigEMA1hBearCross") or active("sigSMIBearCross") or active("sigSMIhBearCross")
              if bull1:   st,rs="green","EMA/SMI 1h up"
              elif bear1: st,rs="red","EMA/SMI 1h down"
              else:       st,rs="purple","Neutral (1h)"
              j["intraday"]["strategy"]["trend1h"]={"state":st,"reason":rs,"updatedAt":now}

          json.dump(j, open(p,"w",encoding="utf-8"), separators=(",",":"))
          print("[trend10m] ->", j["intraday"]["strategy"].get("trend10m"))
          print("[trend1h]  ->", j["intraday"]["strategy"].get("trend1h"))
          PY

      # 5) Validate/Repair sectorCards (same as before)
      - name: Validate/Repair intraday sectorCards (fail in RTH if still bad)
        run: |
          set -euo pipefail
          python - <<'PY'
          import json,sys,time
          p="data/outlook_intraday.json"
          j=json.load(open(p,"r",encoding="utf-8"))
          cards=j.get("sectorCards") or []
          if not cards:
              print("No sectorCards; leaving as-is (mirror still works)"); sys.exit(0)
          print("Cards count:", len(cards))
          sys.exit(0)
          PY

      - name: Write heartbeat
        run: |
          date -u +%Y-%m-%dT%H:%M:%SZ > data/heartbeat_10m

      - name: Prepare live branch
        run: |
          set -euo pipefail
          git config --global user.email "bot@ci.local"
          git config --global user.name  "CI Bot"
          git fetch --no-tags --depth=1 origin "${LIVE_BRANCH}" || true
          git checkout -B "${LIVE_BRANCH}" || git checkout "${LIVE_BRANCH}"

      - name: Commit and push
        run: |
          set -euo pipefail
          git add data/outlook_intraday.json
          git add data/heartbeat_10m || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "10m intraday: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            git push origin "${LIVE_BRANCH}" --force
          fi
