name: dashboard-10min (self-hosted)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * 1-5"

jobs:
  tenmin:
    name: Build and Publish Intraday (self-hosted)
    runs-on:
      - self-hosted
      - Windows
      - tenmin
    timeout-minutes: 20
    concurrency:
      group: dashboard-10min
      cancel-in-progress: true

    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      # fast collector knobs
      FD_SCALPER_ENABLE: "true"
      FD_SCALPER_LOOKBACK: "3"
      FD_MAX_WORKERS: "6"
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Market hours guard (AZ)
        id: guard
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $env:TZ = "America/Phoenix"
          $hour = (Get-Date -Format "HH")
          $dow  = (Get-Date -UFormat "%u")   # 1..7
          if ([int]$dow -ge 6) { "Weekend - skipping"; echo "run=false" >> $env:GITHUB_OUTPUT; exit 0 }
          if ([int]$hour -lt 6 -or [int]$hour -gt 18) { "Outside market window - skipping"; echo "run=false" >> $env:GITHUB_OUTPUT; exit 0 }
          echo "run=true" >> $env:GITHUB_OUTPUT

      - name: Build sectorCards source (today only)
        if: ${{ steps.guard.outputs.run == 'true' }}
        shell: pwsh
        run: |
          mkdir -Force data | Out-Null
          python .\scripts\build_outlook_source_from_polygon.py --mode intraday10 --out data\outlook_source.json
          Copy-Item -Force data\outlook_source.json C:\Windows\Temp\outlook_source.json

      - name: Normalize sector source
        if: ${{ steps.guard.outputs.run == 'true' }}
        shell: pwsh
        run: |
          $json = Get-Content -Raw -Path data\outlook_source.json | ConvertFrom-Json
          if (-not $json.sectorCards -and -not $json.groups) {
            Write-Host "No sector data. Exiting."
            exit 0
          }

      - name: Build intraday payload (10m)
        if: ${{ steps.guard.outputs.run == 'true' }}
        shell: pwsh
        run: |
          python .\scripts\make_intermediate.py  # if you have it; otherwise remove
          python .\scripts\make_dashboard.py --mode intraday --source data\outlook_source.json --out data\outlook_intraday.json

      - name: Enrich (trend/pills) â€” JSON only
        if: ${{ steps.guard.outputs.run == 'true' }}
        shell: pwsh
        run: |
          if (Test-Path .\scripts\compute_trend10m.py) { python .\scripts\compute_trend10m.py } 
          if (Test-Path .\scripts\update_pills_10m_state.py) { python .\scripts\update_pills_10m_state.py }

      - name: Write heartbeat
        if: ${{ steps.guard.outputs.run == 'true' }}
        shell: pwsh
        run: |
          $now = (Get-Date).ToUniversalTime().ToString("s") + "Z"
          Set-Content -Path data\heartbeat_10min.txt -Value $now

      - name: Detect changes vs live branch
        if: ${{ steps.guard.outputs.run == 'true' }}
        id: diff
        shell: pwsh
        env:
          RAW_URL: https://raw.githubusercontent.com/bfrye1973/frye-market-backend/data-live-10min/data/outlook_intraday.json
        run: |
          $ProgressPreference = 'SilentlyContinue'
          $tmp = "$env:temp\live10.json"
          try { Invoke-WebRequest -Uri $env:RAW_URL -UseBasicParsing -OutFile $tmp -ErrorAction Stop } catch { "" | Out-Null }
          if (Test-Path $tmp) {
            $a = Get-Content -Raw -Path data\outlook_intraday.json
            $b = Get-Content -Raw -Path $tmp
            if ($a -eq $b) { echo "changed=false" >> $env:GITHUB_OUTPUT; exit 0 }
          }
          echo "changed=true" >> $env:GITHUB_OUTPUT

      - name: Publish to live branch (minimal)
        if: ${{ steps.guard.outputs.run == 'true' && steps.diff.outputs.changed == 'true' }}
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "bot@ci.local"
          git config user.name  "CI Bot"
          git fetch origin $env:LIVE_BRANCH || echo "no remote branch yet"
          Copy-Item -Force data\outlook_intraday.json data\outlook_intraday.json
          Copy-Item -Force data\heartbeat_10min.txt data\heartbeat_10min.txt
          git add data\outlook_intraday.json data\heartbeat_10min.txt
          git commit -m "tenmin: $(Get-Date -Format o)" || echo "Nothing to commit"
          git push origin HEAD:$env:LIVE_BRANCH --force

      - name: Done
        if: ${{ steps.guard.outputs.run == 'true' }}
        shell: pwsh
        run: echo "10m run finished."
