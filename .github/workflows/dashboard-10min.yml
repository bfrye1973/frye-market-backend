name: dashboard-10min

on:
  workflow_dispatch: {}
  schedule:
    # Stabilized cadence (no overlap). Change back to */10 later if you want.
    - cron: "*/12 * * * 1-5"

jobs:
  tenmin:
    name: Build & Publish Intraday (10m + Lux + Pulse)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: write
    concurrency:
      group: dashboard-10min
      # Keep newest, cancel older in-flight to avoid overlap/429s
      cancel-in-progress: true

    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      PYTHONUNBUFFERED: "1"

      # collector knobs â€“ predictable runtime
      FD_SCALPER_ENABLE: "true"
      FD_SCALPER_LOOKBACK: "3"
      FD_MAX_WORKERS: "6"
      FD_RETRY_MAX: "1"
      FD_LOOKBACK_DAYS: "0"

      # paths
      INTRADAY_JSON_PATH: "data/outlook_intraday.json"
      HOURLY_URL: "https://fr ye-market-backend-1.onrender.com/live/hourly"
      INTRADAY_URL: "https://fr ye-market-backend-1.onrender.com/live/intraday"

      # (optional) used by compute_pulse10m.py for pulseDelta
      PREV_JSON_URL: "https://raw.githubusercontent.com/bfrye1973/frye-market-backend/data-live-10min/data/outlook_intraday.json"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # --- Build intraday source from Polygon (today-only) ---
      - name: Build sectorCards source (10m)
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          FD_SCALPER_ENABLE: ${{ env.FD_SCALPER_ENABLE }}
          FD_SCALPER_LOOKBACK: ${{ env.FD_SCALPER_LOOKBACK }}
          FD_MAX_WORKERS: ${{ env.FD_MAX_WORKERS }}
          FD_RETRY_MAX: ${{ env.FD_RETRY_MAX }}
          FD_LOOKBACK_DAYS: ${{ env.FD_LOOKBACK_DAYS }}
        run: |
          set -euo pipefail
          mkdir -p data
          echo "::notice::collector starting"
          python -u scripts/build_outlook_intraday.py \
            --mode intraday10 \
            --out data/outlook_source.json
          echo "::notice::collector done"

      - name: Normalize sector source (light)
        run: |
          set -euo pipefail
          python - <<'PY'
          import json,sys
          p="data/outlook_source.json"
          try:
            j=json.load(open(p,"r",encoding="utf-8"))
          except Exception as e:
            print("[norm] ERROR reading source:", e); sys.exit(1)

          ok = isinstance(j.get("sectorCards"), list) or isinstance(j.get("groups"), dict)
          print("[norm] source ok?", ok)
          if not ok:
            print("[norm] INVALID source: no sectorCards/groups"); sys.exit(1)
          # if groups only, we leave conversion to make_dashboard.py
          PY

      # --- Build the actual intraday payload ---
      - name: Build intraday payload (FULL)
        run: |
          set -euo pipefail
          python -u scripts/make_dashboard.py \
            --source data/outlook_source.json \
            --out    $INTRADAY_JSON_PATH

      # --- Lux compute (reads & writes data/outlook_intraday.json) ---
      - name: Compute Lux strategy (10m)
        run: |
          set -euo pipefail
          python -u scripts/compute_trend10m.py || true

      # --- Pulse compute (writes pulse10m + mirrors risingPct for sectorDirection10m) ---
      - name: Compute Pulse (10m)
        env:
          INTRADAY_JSON_PATH: ${{ env.INTRADAY_JSON_PATH }}
          PREV_JSON_URL: ${{ env.PREV_JSON_URL }}
        run: |
          set -euo pipefail
          python -u scripts/compute_pulse10m.py
          # quick check for pulse + risingPct in file
          echo "------ pulse10m preview ------"
          jq '.pulse10m // {} | {signal, pulseDelta, offenseTilt, defensiveTilt, greenCount, redCount, risingPct}' "$INTRADAY_JSON_PATH" || true
          echo "------ intraday.sectorDirection10m preview ------"
          jq '.intraday.sectorDirection10m // {}' "$INTRADAY_JSON_PATH" || true

      # --- Stamp updated time for UI ---
      - name: Stamp last_full_run_utc
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, datetime
          p="data/outlook_intraday.json"
          j=json.load(open(p,"r",encoding="utf-8"))
          j.setdefault("meta", {})["last_full_run_utc"] = datetime.datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
          json.dump(j, open(p,"w",encoding="utf-8"), ensure_ascii=False, separators=(",",":"))
          print("[stamp] done")
          PY

      # --- Publish only if changed ---
      - name: Stage artifacts
        run: |
          set -euo pipefail
          mkdir -p /tmp/live10
          cp -f data/outlook_intraday.json /tmp/live10/outlook_intraday.json

      - name: Detect change vs remote
        id: diff
        env:
          LIVE_BRANCH: ${{ env.LIVE_BRANCH }}
        run: |
          set -euo pipefail
          CHG="true"
          if git ls-remote --exit-code --heads origin "${LIVE_BRANCH}" >/dev/null 2>&1; then
            git fetch --no-tags --depth=1 origin "${LIVE_BRANCH}"
            git show "origin/${LIVE_BRANCH}:data/outlook_intraday.json" > /tmp/prev.json 2>/dev/null || true
            if [ -s /tmp/prev.json ] && cmp -s /tmp/prev.json /tmp/live10/outlook_intraday.json; then
              CHG="false"
            fi
          fi
          echo "changed=${CHG}" >> "$GITHUB_OUTPUT"

      - name: Publish live branch
        if: ${{ steps.diff.outputs.changed == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LIVE_BRANCH: ${{ env.LIVE_BRANCH }}
        run: |
          set -euo pipefail
          git config user.name  "actions-bot"
          git config user.email "bot@users.noreply.github.com"
          git reset --hard
          git clean -fdx
          git checkout -B "${LIVE_BRANCH}" || true
          git pull --rebase origin "${LIVE_BRANCH}" || true
          mkdir -p data
          cp -f /tmp/live10/outlook_intraday.json data/outlook_intraday.json
          git add data/outlook_intraday.json
          git commit -m "10m publish $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "nothing to commit"
          git push -f origin "${LIVE_BRANCH}"
