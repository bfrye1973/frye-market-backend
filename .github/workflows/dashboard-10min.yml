name: dashboard-10min (self-hosted)

on:
  schedule:
    - cron: "*/10 * * * *"   # every 10 minutes
  workflow_dispatch:

# Make sure only one 10-minute job runs at a time
concurrency:
  group: dashboard-10min
  cancel-in-progress: true

jobs:
  build_10m:
    name: Build and Publish Intraday (self-hosted)
    runs-on: [self-hosted, Windows, tenmin]

    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      # if your scripts use Polygon:
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}

    steps:
      - name: Checkout (sparse; exclude data/archive/**)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Avoid Windows path issues by not checking out "data/archive/**"
          sparse-checkout: |
            /
            !data/archive/**
          sparse-checkout-cone: false

      # Ensure Python and requests are available on the runner
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade requests

      # OPTIONAL: quick open-window guard (remove if you donâ€™t want it)
      - name: Open-window guard (4:55â€“18:59 AZ)
        shell: bash
        run: |
          set -e
          TZ="America/Phoenix"
          now_h=$(date +"%H" -d "TZ=\"$TZ\" now")
          now_m=$(date +"%M" -d "TZ=\"$TZ\" now")
          # allow from 04:55 to 18:59 AZ (adjust if needed)
          if [ "$now_h$now_m" -lt "0455" ] || [ "$now_h" -gt 18 ]; then
            echo "ðŸ”• Outside run window. Exiting early."
            exit 0
          fi

      # === Your build steps ===
      - name: Build sectorCards source (only)
        shell: bash
        run: |
          set -e
          echo "Building 10m sector sourceâ€¦"
          python -u scripts/build_outlook_source_from_polygon.py --mode intraday10 --out data/outlook_source.json

      - name: Normalize sector source
        shell: bash
        run: |
          set -e
          echo "Normalizing sector sourceâ€¦"
          python - <<'PY'
          import json, sys
          p="data/outlook_source.json"
          with open(p, "r", encoding="utf-8") as f:
              j = json.load(f)
          # if you need to reshape groups -> sectorCards, keep your existing logic here
          # (Assumes your source script already writes `sectorCards`)
          if "sectorCards" not in j:
              print("âŒ No sectorCards in source. Aborting.")
              sys.exit(2)
          # Re-write to ensure consistent JSON formatting
          with open(p, "w", encoding="utf-8") as f:
              json.dump(j, f, ensure_ascii=False)
          print("âœ… sectorCards present, source OK")
          PY

      - name: Build intraday payload
        shell: bash
        run: |
          set -e
          echo "Building intraday payloadâ€¦"
          python -u scripts/make_dispatch.py --source data/outlook_source.json --out data/outlook_intraday.json || \
          python -u scripts/make_dashboard.py --mode intraday --source data/outlook_source.json --out data/outlook_intraday.json
          test -f data/outlook_intraday.json

      - name: Enrich (trend/pills) â€” JSON only
        shell: bash
        run: |
          set -e
          echo "Enriching payload (trend/pills)â€¦"
          # These scripts must NOT call git / checkout; they should read JSON only
          if [ -f scripts/compute_trend10m.py ]; then
            python -u scripts/compute_trend10m.py || true
          fi
          if [ -f scripts/update_pills_10m_state.py ]; then
            python -u scripts/update_pills_10m_state.py || true
          fi

      - name: Write heartbeat
        shell: bash
        run: |
          set -e
          date -u +"%Y-%m-%dT%H:%M:%SZ" > data/heartbeat_10min.txt

      # Publish only if something changed
      - name: Prepare publish (copy artifacts)
        shell: bash
        run: |
          set -e
          mkdir -p /tmp/live10
          cp -f data/outlook_intraday.json /tmp/live10/outlook_intraday.json
          cp -f data/heartbeat_10min.txt /tmp/live10/heartbeat_10min.txt

      - name: Publish to ${{ env.LIVE_BRANCH }}
        shell: bash
        run: |
          set -e
          git config --global user.email "bot@ci.local"
          git config --global user.name "CI Bot"
          git fetch origin "${LIVE_BRANCH}" || true
          git checkout -B "${LIVE_BRANCH}" "origin/${LIVE_BRANCH}" 2>/dev/null || git checkout --orphan "${LIVE_BRANCH}"
          # place artifacts
          rm -rf data || true
          mkdir -p data
          cp -f /tmp/live10/outlook_intraday.json data/outlook_intraday.json
          cp -f /tmp/live10/heartbeat_10min.txt data/heartbeat_10min.txt
          git add data
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi
          git commit -m "10m publish $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push -f origin "${LIVE_BRANCH}"

      - name: Done
        run: echo "âœ… 10m build complete"
