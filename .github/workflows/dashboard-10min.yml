name: dashboard-10min (self-hosted, full)

on:
  workflow_dispatch: {}
  schedule:
    # US market window in UTC (Mon–Fri):
    # Start 2h before open (07:30 ET ≈ 12:30 UTC in Standard Time), run through 20:00 ET (01:00 UTC next day).
    - cron: "30-55/5 12 * * 1-5"   # 12:30–12:55 UTC every 5m
    - cron: "*/5 13-23 * * 1-5"    # 13:00–23:55 UTC every 5m
    - cron: "*/5 0-1 * * 2-6"      # 00:00–01:00 UTC every 5m (covers 20:00 ET)

jobs:
  tenmin:
    name: Build & Publish Intraday (10m — production)
    runs-on: self-hosted
    timeout-minutes: 30
    permissions:
      contents: write
    concurrency:
      group: dashboard-10min
      cancel-in-progress: false

    env:
      TZ: America/Phoenix
      LIVE_BRANCH: data-live-10min
      PYTHONUNBUFFERED: "1"

      # Intraday tuning
      FD_SCALPER_ENABLE: "true"
      FD_SCALPER_LOOKBACK: "3"
      FD_LOOKBACK_DAYS: "0"
      FD_MAX_WORKERS: "3"
      FD_RETRY_MAX: "1"

      # Polygon secrets (either works)
      POLY_KEY: ${{ secrets.POLY_KEY }}
      POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}

      # TEMP: force one clean publish to reseed BOTH files (set to "false" after you verify)
      FORCE_PUBLISH: "true"

    steps:
      # ---------- T0 ----------
      - name: Start timer (UTC)
        shell: cmd
        run: |
          for /f "tokens=2 delims==" %%A in ('wmic os get localdatetime /value ^| find "="') do set TS=%%A
          set START_TS=%TS:~0,4%-%TS:~4,2%-%TS:~6,2%T%TS:~8,2%:%TS:~10,2%:%TS:~12,2%Z
          echo START_TS=%START_TS%
          echo ==== 10m run started at %START_TS%

      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure tzdata (IANA DB for zoneinfo on Windows)
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade tzdata
          python -c "import sys,zoneinfo; print('python',sys.version); print('zoneinfo OK:', bool(zoneinfo.ZoneInfo))"

      # 1) Build intraday10 groups → outlook_source.json
      - name: Build sectorCards source (intraday10)
        shell: cmd
        run: |
          echo ==== BUILD outlook_source.json (intraday10) ====
          if not exist data mkdir data
          python -u scripts\build_outlook_source_from_polygon.py ^
            --mode intraday10 ^
            --sectors-dir data\sectors ^
            --out data\outlook_source.json
          if errorlevel 1 exit /b 1
          rem (optional) preview
          for /f "tokens=*" %%A in ('powershell -NoProfile -Command "(Get-Content -Raw data\outlook_source.json).Substring(0,[Math]::Min(800,(Get-Item data\outlook_source.json).Length))"') do @echo %%A

      # 2) Transform groups → outlook_intraday.json
      - name: Build intraday payload (10m)
        shell: cmd
        run: |
          echo ==== MAKE outlook_intraday.json ====
          python -u scripts\make_dashboard.py ^
            --mode intraday ^
            --source data\outlook_source.json ^
            --out data\outlook_intraday.json
          if errorlevel 1 exit /b 1

      # 3) Lux hook (10m) — safe on failure
      - name: Compute Lux strategy (10m)
        shell: cmd
        run: |
          echo ==== COMPUTE trend10m / lux10m ====
          python -u scripts\compute_trend10m.py
        continue-on-error: true

      # 4) Engine-Light pills (10m) — safe on failure
      - name: Update pills (10m always-on)
        shell: cmd
        run: |
          echo ==== UPDATE engineLights pills (10m) ====
          python -u scripts\update_pills_10m_state.py
        continue-on-error: true

      # 5) Validate structure (CMD-safe single line)
      - name: Validate required keys
        shell: cmd
        run: |
          echo ==== VALIDATE outlook_intraday.json ====
          python -u -c "import json,sys; j=json.load(open('data/outlook_intraday.json','r',encoding='utf-8')); m=j.get('metrics') or {}; need=['breadth_10m_pct','momentum_10m_pct','squeeze_pct','liquidity_psi','volatility_pct']; miss=[k for k in need if k not in m]; sc=j.get('sectorCards') or []; sys.exit(1) if miss else None; print('OK metrics & sectors:', len(sc))"

      # 6) Write heartbeat (ensures branch advances even on flat data)
      - name: Write heartbeat
        shell: cmd
        run: |
          for /f "tokens=2 delims==" %%A in ('wmic os get localdatetime /value ^| find "="') do set TS=%%A
          set HB=%TS:~0,4%-%TS:~4,2%-%TS:~6,2%T%TS:~8,2%:%TS:~10,2%:%TS:~12,2%Z
          echo %HB%> data\heartbeat_10m
          type data\heartbeat_10m

      # 7) Stage artifacts
      - name: Stage artifacts
        shell: cmd
        run: |
          if not exist publish mkdir publish
          copy /Y data\outlook_source.json   publish\outlook_source.json
          copy /Y data\outlook_intraday.json publish\outlook_intraday.json
          copy /Y data\heartbeat_10m        publish\heartbeat_10m
          dir publish

      # 8) Detect change vs remote (publish if heartbeat OR json changed)
      - name: Detect change vs remote
        id: diff
        shell: cmd
        run: |
          echo ==== DIFF against %LIVE_BRANCH% ====
          git fetch origin %LIVE_BRANCH% --depth=1 || echo (no remote branch yet)
          set CHANGED=true
          if exist _remote_tmp rd /s /q _remote_tmp
          mkdir _remote_tmp

          for /f "tokens=*" %%A in ('git ls-remote --heads origin %LIVE_BRANCH% ^| findstr refs/heads/%LIVE_BRANCH%') do set HAVE_BRANCH=1
          if not defined HAVE_BRANCH (
            echo (first publish)
          ) else (
            git --work-tree="_remote_tmp" checkout origin/%LIVE_BRANCH% -- "data\outlook_intraday.json" 2>nul || echo (remote intraday missing)
            git --work-tree="_remote_tmp" checkout origin/%LIVE_BRANCH% -- "data\heartbeat_10m"        2>nul || echo (remote heartbeat missing)

            set CHANGED=true
            if exist "_remote_tmp\data\outlook_intraday.json" (
              fc /B publish\outlook_intraday.json "_remote_tmp\data\outlook_intraday.json" >nul 2>&1
              set JSON_SAME=%ERRORLEVEL%
            ) else (
              set JSON_SAME=1
            )
            if exist "_remote_tmp\data\heartbeat_10m" (
              fc /B publish\heartbeat_10m "_remote_tmp\data\heartbeat_10m" >nul 2>&1
              set HB_SAME=%ERRORLEVEL%
            ) else (
              set HB_SAME=1
            )
            if "%JSON_SAME%"=="0" if "%HB_SAME%"=="0" (
              echo (no differences in intraday or heartbeat) & set CHANGED=false
            ) else (
              echo (differences detected) & set CHANGED=true
            )
          )

          rem ONE-TIME FORCE to reseed both JSON files on the live branch
          if /I "%FORCE_PUBLISH%"=="true" set CHANGED=true

          echo changed=%CHANGED%>> "%GITHUB_OUTPUT%"
          echo changed=%CHANGED%> change.txt
          echo DIFF_CHANGED=%CHANGED%

      # 9) Publish (only when changed) — always writes BOTH files; force-add source even if ignored
      - name: Publish live branch (safe)
        if: ${{ steps.diff.outputs.changed == 'true' }}
        shell: cmd
        run: |
          echo ==== PUBLISH to %LIVE_BRANCH% ====
          git config user.email "user@local"
          git config user.name  "CI Bot"
          git fetch --depth=1 origin %LIVE_BRANCH% || echo (creating)
          git checkout -B %LIVE_BRANCH% "origin/%LIVE_BRANCH%" || git checkout -B %LIVE_BRANCH%

          if exist data rd /s /q data
          mkdir data
          copy /Y publish\outlook_source.json   data\outlook_source.json
          copy /Y publish\outlook_intraday.json data\outlook_intraday.json
          copy /Y publish\heartbeat_10m        data\heartbeat_10m

          rem If .gitignore blocks outlook_source.json, force-add it explicitly.
          git add -f data\outlook_source.json
          git add -A

          git commit -m "10m publish %START_TS%" || (echo (nothing to commit) & exit /b 0)
          git push -f origin %LIVE_BRANCH%
          echo ==== PUBLISHED ====

      - name: Done
        shell: cmd
        run: |
          echo ==== DONE %DATE% %TIME%
