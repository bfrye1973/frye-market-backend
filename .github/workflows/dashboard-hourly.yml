name: dashboard-hourly

on:
  schedule:
    # Run at 30 minutes past each hour between 13:30 and 20:30 UTC (9:30am–4:30pm ET)
    - cron: '30 13-20 * * 1-5'

  workflow_dispatch:

concurrency:
  group: dashboard-hourly
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout clean main
        uses: actions/checkout@v4
        with:
          # full history not needed, but safest is to ensure clean base
          fetch-depth: 0

      - name: Reset working tree to origin/main
        run: |
          git fetch origin main
          git reset --hard origin/main

      # If your builder uses Python, keep this. If Node, swap to setup-node.
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (if needed)
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build outlook.json
        run: |
          # Replace with your real builder command
          # Example:
          python scripts/make_dashboard.py

      - name: Ensure outlook.json exists
        run: test -f data/outlook.json

      - name: Validate outlook.json (no conflict markers, valid JSON)
        run: |
          if grep -E '<<<<<<<|=======|>>>>>>>' -n data/outlook.json; then
            echo "❌ conflict markers found in data/outlook.json"; exit 1;
          fi
          # requires jq; preinstalled on ubuntu-latest
          jq . data/outlook.json > /dev/null

      - name: Commit if changed
        run: |
          git add data/outlook.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git -c user.email="actions@github.com" -c user.name="GitHub Actions" commit -m "hourly: refresh outlook.json"
            git push origin HEAD:main
          fi
