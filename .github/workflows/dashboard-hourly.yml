name: dashboard-hourly

on:
  schedule:
    # Run once per hour from 13:30 to 20:30 UTC (market open to close)
    - cron: "30 13-20 * * 1-5"
  workflow_dispatch:

jobs:
  hourly:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Skip if outside market hours (scheduled runs only)
        if: github.event_name == 'schedule'
        run: |
          HOUR=$(date -u +"%H")
          if [ "$HOUR" -lt 13 ] || [ "$HOUR" -gt 20 ]; then
            echo "⏩ Outside market hours. Skipping."
            exit 0
          fi

      - name: Make dashboard (intraday)
        run: python scripts/make_dashboard.py --mode intraday

      - name: Archive (15-day rolling) — HOURLY
        run: |
          mkdir -p archive/hourly
          cp data/outlook.json archive/hourly/outlook_$(date -u +%Y-%m-%dT%H-%M-%SZ).json
          cp data/outlook_source.json archive/hourly/outlook_source_$(date -u +%Y-%m-%dT%H-%M-%SZ).json

      - name: Commit latest → hourly archive (rebase-safe)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A || true
          git diff --staged --quiet || git commit -m "Hourly update [skip ci]" || true
          git pull --rebase origin main || true
          git push origin main || true
